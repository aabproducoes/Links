<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portf√≥lio ‚Äî AAB Produ√ß√µes</title>
  <meta name="color-scheme" content="dark light">
  <style>
    /* ===== THEME TOKENS (escuro / claro) ===== */
    body{ margin:0; font:14.5px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    body[data-theme="dark"]{
      --bg:#0b0d12; --panel:#0f131b; --muted:#97a0b0; --text:#e6ebf2;
      --accent:#00e0ff; --accent-2:#00ff87; --border:#1a2230;
      --soft:#111826; --soft-2:#0f1722; --glowA: rgba(0,224,255,.06); --glowB: rgba(0,224,255,.15);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      background:radial-gradient(1200px 800px at -10% -20%, #101525 0%, var(--bg) 50%, #0a0d13 100%);
      color:var(--text);
    }
    body[data-theme="light"]{
      --bg:#f5f7fb; --panel:#ffffff; --muted:#5d6778; --text:#0e1726;
      --accent:#007bff; --accent-2:#21c97a; --border:#dfe6ee;
      --soft:#f2f6fb; --soft-2:#eef3fa; --glowA: rgba(0,123,255,.08); --glowB: rgba(0,123,255,.25);
      --shadow: 0 10px 30px rgba(10,35,80,.10);
      background:linear-gradient(180deg, #f7faff 0%, #edf3fb 100%);
      color:var(--text);
    }
    :root{ color-scheme: light dark }
    *{ box-sizing: border-box }
    .app{ display:flex; min-height:100dvh; gap:0 }

    /* ===== SIDEBAR ===== */
    .sidebar{
      width: 300px; max-width: 85vw; background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 95%, transparent) 0%, var(--panel) 100%);
      border-right:1px solid var(--border); position:relative; box-shadow: var(--shadow);
      display:flex; flex-direction:column; min-width:240px;
    }
    .brand{ padding:16px 16px 8px; border-bottom:1px solid var(--border) }
    .brand h1{ margin:0; font-size:18px; letter-spacing:.3px; display:flex; align-items:center; gap:8px }
    .badge{ font-size:11px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted) }

    .filter-wrap{ padding:8px 12px; border-bottom:1px solid var(--border) }
    .filter{
      width:100%; padding:8px 10px; border-radius:10px;
      border:1px solid color-mix(in oklab, var(--border) 80%, transparent);
      background:var(--soft); color:inherit; outline:none
    }

    .about{
      padding:12px 16px; border-bottom:1px solid var(--border);
      display:grid; grid-template-columns:40px 1fr; gap:12px; align-items:center;
    }
    .avatar{
      width:40px; height:40px;
      border-radius:12px;
      object-fit:cover;
      display:block;
      box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 35%, transparent);
    }
    .about h2{ margin:0; font-size:14px }
    .about p{ margin:.25rem 0 0; font-size:12.5px; color:var(--muted) }

    nav{ padding:10px 8px 14px 8px; overflow:auto; flex:1 }
    .link{
      appearance:none; width:100%; text-align:left; border:0; background:transparent; color:var(--text);
      padding:12px 14px; margin:6px; border-radius:14px; cursor:pointer; position:relative; outline:none; display:flex; align-items:center; gap:10px;
      transition: transform .15s ease, background .25s ease, box-shadow .25s ease;
      overflow: hidden;
    }
    .link:hover{ background:var(--soft); transform: translateX(2px) }
    .link:focus-visible{ box-shadow: 0 0 0 2px var(--glowB) }
    .link:active{ transform: translateX(1px) scale(.99) }

    .link .dot{ width:10px; height:10px; border-radius:50%; background:linear-gradient(135deg, var(--accent), var(--accent-2)); opacity:.9; box-shadow:0 0 12px color-mix(in oklab, var(--accent) 50%, transparent) }
    .link .label{ flex:1 }
    .link .open{
      opacity:.8; font-size:12px; padding:2px 8px; border-radius:999px;
      border:1px solid color-mix(in oklab, var(--border) 80%, transparent);
      background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 70%, transparent), transparent);
    }

    /* Spotlight din√¢mico (coordenadas via --x/--y) */
    .link::after{
      content:""; position:absolute; inset:-1px; border-radius:14px; pointer-events:none;
      background: radial-gradient(140px 80px at var(--x,50%) var(--y,50%),
        color-mix(in oklab, var(--accent) 18%, transparent),
        transparent 60%);
      opacity: 0; transition: opacity .25s ease;
    }
    .link:hover::after{ opacity:.6 }

    /* Ripple no clique */
    .link::before{
      content:""; position:absolute; width:12px; height:12px; border-radius:50%; pointer-events:none; opacity:0; transform:scale(0);
      background: color-mix(in oklab, var(--accent) 55%, transparent);
      filter: blur(1px);
    }
    @keyframes aab-ripple{ from{ transform:translate(var(--rx,0), var(--ry,0)) scale(0); opacity:.35 } to{ transform:translate(var(--rx,0), var(--ry,0)) scale(16); opacity:0 } }
    .link.juice-rippling::before{ animation: aab-ripple .55s ease-out forwards; }

    .link.active{
      background:linear-gradient(180deg, var(--soft-2), var(--soft));
      border:1px solid color-mix(in oklab, var(--accent) 30%, var(--border));
      box-shadow:
        inset 0 0 0 1px color-mix(in oklab, var(--accent) 35%, transparent),
        inset 0 0 24px var(--glowA),
        0 6px 22px rgba(0,0,0,.08);
    }
    @keyframes aab-pulse{ 0%{ transform:scale(.9); opacity:.7 } 50%{ transform:scale(1.15); opacity:1 } 100%{ transform:scale(.9); opacity:.7 } }
    .link.active .dot{ animation: aab-pulse 1.8s ease-in-out infinite }

    .hint{ margin:8px 14px 0; color:var(--muted); font-size:12px }

    /* Resizer */
    .resizer{ position:absolute; right:-3px; top:0; width:6px; height:100%; cursor: col-resize; background: transparent; }
    .resizer::after{ content:""; position:absolute; inset:0; opacity:0; transition:.2s; background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 40%, transparent), transparent 60%) }
    .resizer:hover::after, .resizing .resizer::after{ opacity:.6 }

    /* ===== MAIN PANE ===== */
    .main{ flex:1; min-width:0; position:relative; display:flex; flex-direction:column }
    .toolbar{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid var(--border); background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 85%, transparent), var(--panel));
    }
    .toolbar .left, .toolbar .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .btn{ color:var(--text); background:var(--soft); border:1px solid color-mix(in oklab, var(--border) 80%, transparent); padding:8px 10px; border-radius:12px; cursor:pointer; user-select:none }
    .btn:hover{ filter:brightness(1.03) }
    .btn:focus-visible{ outline:none; box-shadow: 0 0 0 2px var(--glowB) }
    .title{ font-size:13px; color:var(--muted) }
    .title strong{ color:var(--text) }
    .viewer{ position:relative; flex:1; min-height:0 }
    iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; background:var(--bg) }
    .loading{
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
      background: radial-gradient(600px 300px at 50% -10%, var(--glowA), transparent 40%);
    }
    .spinner{
      width:56px; height:56px; border-radius:50%; border:3px solid rgba(127,127,127,.18);
      border-top-color: var(--accent); border-right-color: var(--accent-2);
      animation: spin 1s linear infinite; filter: drop-shadow(0 0 14px color-mix(in oklab, var(--accent) 45%, transparent));
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .footer{
      padding:8px 12px; border-top:1px solid var(--border); color:var(--muted); font-size:12px;
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 85%, transparent), var(--panel));
    }

    /* ===== MOBILE ===== */
    .hamburger{ display:none }
    @media (max-width: 860px){
      .app{ flex-direction:column }
      .sidebar{ width:100% !important; border-right:0; border-bottom:1px solid var(--border) }
      .resizer{ display:none }
      .hamburger{ display:inline-flex }
      nav{ display:none }
      .sidebar.open nav{ display:block; max-height:60vh }
    }

    /* ===== GLASS ===== */
    @supports (backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px)) {
      .sidebar,
      .toolbar,
      .footer {
        background: color-mix(in oklab, var(--panel) 65%, transparent);
        border-color: color-mix(in oklab, var(--border) 60%, transparent);
        -webkit-backdrop-filter: blur(14px) saturate(140%) brightness(1.05);
        backdrop-filter: blur(14px) saturate(140%) brightness(1.05);
        box-shadow: 0 8px 30px rgba(0,0,0,.20);
      }
      .link{
        background: color-mix(in oklab, var(--soft) 50%, transparent);
        border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
      }
      .link:hover{
        background: color-mix(in oklab, var(--soft) 75%, transparent);
        box-shadow: 0 6px 20px rgba(0,0,0,.20), inset 0 0 0 1px color-mix(in oklab, var(--accent) 12%, transparent);
      }
      .link.active{
        background: color-mix(in oklab, var(--soft-2) 80%, transparent);
      }
    }
    @supports not ((backdrop-filter: blur(10px))) {
      .sidebar, .toolbar, .footer {
        background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 80%, transparent), var(--panel));
      }
    }
    .sidebar, .toolbar, .footer{
      border: 1px solid color-mix(in oklab, var(--border) 80%, transparent);
    }

    /* ===== WATER TEXT ===== */
    .water-text{
      position: relative;
      display: inline-block;
      font-weight: 800;
      letter-spacing: .3px;
      background:
        radial-gradient(120% 180% at 50% 0%, color-mix(in oklab, var(--accent) 75%, #fff) 0%, transparent 60%) ,
        conic-gradient(from 180deg at 50% 50%, var(--accent), var(--accent-2), var(--accent), var(--accent-2));
      background-size: 160% 160%, 200% 200%;
      background-position: 50% 0%, 50% 50%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      filter: url(#aab-water-ripple);
      text-shadow:
        0 1px 0 rgba(255,255,255,.18),
        0 10px 30px color-mix(in oklab, var(--accent) 20%, transparent);
      animation: aab-water-move 8s ease-in-out infinite;
    }
    @keyframes aab-water-move{
      0%   { background-position: 50% 0%, 45% 50% }
      50%  { background-position: 52% 20%, 55% 60% }
      100% { background-position: 50% 0%, 45% 50% }
    }
    .water-text::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(115deg, transparent 40%, rgba(255,255,255,.45) 50%, transparent 60%);
      mix-blend-mode: screen;
      transform: translateX(-120%);
      animation: aab-water-glare 3.8s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes aab-water-glare{
      0%, 60%   { transform: translateX(-120%) }
      80%       { transform: translateX(0%) }
      100%      { transform: translateX(120%) }
    }
  </style>
</head>
<body data-theme="dark">
  <div class="app" id="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <h1>
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="url(#g)" d="M12 2L2 7l10 5 10-5-10-5Zm0 7L2 4v13l10 5 10-5V4l-10 5Z"/><defs>
              <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="#00e0ff"/><stop offset="1" stop-color="#00ff87"/>
              </linearGradient>
            </defs>
          </svg>
          <span class="water-text">Portf√≥lio</span> <span class="badge">AAB</span>
        </h1>
      </div>

      <!-- Busca no menu -->
      <div class="filter-wrap">
        <input id="filter" class="filter" type="search" placeholder="Filtrar‚Ä¶">
      </div>

      <div class="about">
        <img
          class="avatar"
          src="https://aabproducoes.github.io/Links/images/292440780_2225688030932761_1836941331334930994_n.webp.png"
          alt="Foto de perfil de Antonio Augusto Barbaro"
          loading="lazy" decoding="async"
        />
        <div>
          <h2>Antonio A. Barbaro</h2>
          <p>Fotografia, HTML5/Games e projetos criativos ‚Äî <strong>AAB Produ√ß√µes</strong>.</p>
        </div>
      </div>

      <button class="btn hamburger" aria-controls="menu" aria-expanded="false" id="burger">‚ò∞ Menu</button>
      <nav id="menu" aria-label="Se√ß√µes"><!-- items via JS --></nav>

      <div class="hint" id="hintText">Dicas: 1‚Äì9 para trocar ‚Ä¢ ‚Üë/‚Üì navegam ‚Ä¢ Enter abre ‚Ä¢ Arraste a borda para redimensionar</div>
      <div class="resizer" id="resizer" title="Arraste para redimensionar (duplo clique reseta)"></div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="toolbar">
        <div class="left">
          <span class="title">Visualizando: <strong id="currentTitle">‚Äî</strong></span>
        </div>
        <div class="right">
          <button class="btn" id="themeToggle" aria-pressed="false" title="Alternar tema">Tema: Escuro</button>
          <button class="btn" id="openNew">Abrir em nova aba</button>
          <button class="btn" id="copyLink">Copiar link</button>
          <button class="btn" id="reload">Recarregar</button>
          <button class="btn" id="hardReload" title="Ignora cache">Hard</button>
        </div>
      </div>

      <div class="viewer">
        <div class="loading" id="loading" aria-hidden="true"><div class="spinner" role="status" aria-label="Carregando"></div></div>
        <iframe id="frame" title="Visualiza√ß√£o do portf√≥lio" referrerpolicy="no-referrer"
                src="https://aabproducoes.github.io/Links/blender-projects.html"></iframe>
      </div>

      <div class="footer">
        Feito com ‚ù§ ‚Äî Tema claro/escuro, sidebar redimension√°vel e atalhos. Se alguma p√°gina bloquear <em>iframe</em>, use ‚ÄúAbrir em nova aba‚Äù.
      </div>
    </main>
  </div>

  <script>
    /* ===== CONFIG INTRO/KNOWLEDGE ===== */
    const INTRO_BACK_TARGET = 'blender-projects'; // mude para o ID que quiser voltar como ‚ÄúResume‚Äù
    const KNOW_BASE = "https://aabproducoes.github.io/Links/KnowledgeList/";
    const KNOW_TXT  = KNOW_BASE + "KnowledgeList.txt";

    /* ===== DATA ===== */
    const PAGES = [
      { id:"intro",               key:1, title:"Intro",                         url:"__internal_intro__" },
      { id:"blender-projects",    key:2, title:"Blender ‚Äî Projects",            url:"https://aabproducoes.github.io/Links/blender-projects.html" },
      { id:"blender-animations",  key:3, title:"Blender ‚Äî Animations",          url:"https://aabproducoes.github.io/Links/blender-animations.html" },
      { id:"gimp-projects",       key:4, title:"GIMP ‚Äî Projects",               url:"https://aabproducoes.github.io/Links/gimp-projects.html" },
      { id:"music-visualizer",    key:5, title:"Music Player ‚Äî Visualizer",     url:"https://aabproducoes.github.io/Links/music_player-visualizer.html" },
      { id:"best-shots",          key:6, title:"Best Shots ‚Äî Carousel",         url:"https://aabproducoes.github.io/Links/best-shots-img-caroussell.html" },
      { id:"animated-background", key:7, title:"Animated Background",           url:"https://aabproducoes.github.io/Links/animated-background.html" },
      { id:"html-play",           key:8, title:"HTML Games ‚Äî Play",             url:"https://aabproducoes.github.io/Links/HTML_games/HTML-play.html" },
      { id:"translation",         key:9, title:"Translation",                   url:"https://aabproducoes.github.io/Links/Translation/translation.html" },
      { id:"certificados",        key:0, title:"Certificados",                  url:"__internal_certificados__" }
    ];
    // Nota: "key:0" em certificados para n√£o mostrar n√∫mero na dica (opcional). Os atalhos 1‚Äì9 ficam do Intro ao Translation.

    const CERTS_BASE = "https://aabproducoes.github.io/Links/Certificados/";
    const CERTS_TXT  = CERTS_BASE + "CertificadosList.txt";

    const els = {
      app: document.getElementById('app'),
      sidebar: document.getElementById('sidebar'),
      menu: document.getElementById('menu'),
      frame: document.getElementById('frame'),
      loading: document.getElementById('loading'),
      currentTitle: document.getElementById('currentTitle'),
      openNew: document.getElementById('openNew'),
      copyLink: document.getElementById('copyLink'),
      reload: document.getElementById('reload'),
      hardReload: document.getElementById('hardReload'),
      burger: document.getElementById('burger'),
      resizer: document.getElementById('resizer'),
      themeToggle: document.getElementById('themeToggle'),
      body: document.body,
      hintText: document.getElementById('hintText'),
      filter: document.getElementById('filter')
    };

    const STORE = {
      current: 'aab.portfolio.current',
      theme: 'aab.portfolio.theme',
      width: 'aab.portfolio.sidebarWidth'
    };

    /* ===== MENU RENDER ===== */
    function renderMenu(){
      els.menu.innerHTML = '';
      PAGES.forEach(p=>{
        const btn = document.createElement('button');
        btn.className = 'link';
        btn.dataset.id = p.id;
        btn.dataset.key = String(p.key);
        btn.innerHTML =
          '<span class="dot" aria-hidden="true"></span>'+
          '<span class="label">'+p.title+'</span>'+
          '<span class="open">'+(p.key ? p.key : '')+'</span>';

        // clique normal => carrega no iframe
        btn.addEventListener('click', ()=>loadPage(p.id));

        // middle-click abre em nova aba
        btn.addEventListener('auxclick', (e)=>{
          if (e.button === 1) {
            if (p.url === "__internal_certificados__") window.open(CERTS_TXT, '_blank', 'noopener');
            else if (p.url === "__internal_intro__") window.open(KNOW_TXT, '_blank', 'noopener');
            else window.open(p.url, '_blank', 'noopener');
          }
        });
        // Ctrl/Cmd+click abre nova aba sem trocar o iframe
        btn.addEventListener('click', (e)=>{
          if (e.ctrlKey || e.metaKey) {
            if (p.url === "__internal_certificados__") window.open(CERTS_TXT, '_blank', 'noopener');
            else if (p.url === "__internal_intro__") window.open(KNOW_TXT, '_blank', 'noopener');
            else window.open(p.url, '_blank', 'noopener');
            e.preventDefault();
          }
        });

        // JUICE: spotlight + ripple
        btn.addEventListener('mousemove', (e)=>{
          const r = btn.getBoundingClientRect();
          const x = ((e.clientX - r.left) / r.width) * 100;
          const y = ((e.clientY - r.top)  / r.height)* 100;
          btn.style.setProperty('--x', x + '%');
          btn.style.setProperty('--y', y + '%');
        });
        btn.addEventListener('mouseleave', ()=>{
          btn.style.removeProperty('--x'); btn.style.removeProperty('--y');
        });
        btn.addEventListener('mousedown', (e)=>{
          const r = btn.getBoundingClientRect();
          const rx = (e.clientX - r.left) + 'px';
          const ry = (e.clientY - r.top)  + 'px';
          btn.style.setProperty('--rx', 'calc(' + rx + ' - 6px)');
          btn.style.setProperty('--ry', 'calc(' + ry + ' - 6px)');
          btn.classList.remove('juice-rippling'); void btn.offsetWidth; btn.classList.add('juice-rippling');
          setTimeout(()=>btn.classList.remove('juice-rippling'), 600);
        }, { passive:true });

        // tooltip
        btn.title = p.title;

        els.menu.appendChild(btn);
      });

      const keys = PAGES.map(p=>p.key).filter(Boolean);
      const first = Math.min.apply(null, keys);
      const last  = Math.max.apply(null, keys);
      els.hintText.textContent = 'Dicas: '+first+'‚Äì'+last+' para trocar ‚Ä¢ ‚Üë/‚Üì navegam ‚Ä¢ Enter abre ‚Ä¢ Arraste a borda para redimensionar';

      // Ping de status
      (function markStatus(){
        PAGES.forEach(p=>{
          if (p.url === "__internal_certificados__" || p.url === "__internal_intro__") return;
          const label = els.menu.querySelector('.link[data-id="'+p.id+'"] .label');
          if (!label) return;
          fetch(p.url, { method:'HEAD' })
            .then(()=>{ label.textContent = label.textContent.replace(/^([üü¢üî¥]\s)?/, 'üü¢ '); })
            .catch(()=>{ label.textContent = label.textContent.replace(/^([üü¢üî¥]\s)?/, 'üî¥ '); });
        });
      })();
    }

    /* ===== MENU FILTER ===== */
    function attachMenuFilter(){
      if (!els.filter) return;
      els.filter.addEventListener('input', function(){
        const q = this.value.toLowerCase().trim();
        document.querySelectorAll('#menu .link').forEach(btn=>{
          const label = btn.querySelector('.label')?.textContent.toLowerCase() || '';
          btn.style.display = label.includes(q) ? '' : 'none';
        });
      });
    }

    /* ===== STATE ===== */
    function setActive(id){
      document.querySelectorAll('.link').forEach(b=>b.classList.toggle('active', b.dataset.id === id));
    }
    function getCurrentId(){
      const h = (location.hash || '').replace('#','').trim();
      if (PAGES.find(p=>p.id===h)) return h;
      const saved = localStorage.getItem(STORE.current);
      if (PAGES.find(p=>p.id===saved)) return saved;
      return PAGES[0].id; // Intro
    }
    function isInternalCertPage(id){
      const p = PAGES.find(x=>x.id===id);
      return p && p.url === "__internal_certificados__";
    }
    function isInternalIntroPage(id){
      const p = PAGES.find(x=>x.id===id);
      return p && p.url === "__internal_intro__";
    }

    /* ===== LOAD ===== */
    async function loadPage(id, pushHash=true){
      const item = PAGES.find(p=>p.id===id); if(!item) return;

      // spinner ON
      els.loading.removeAttribute('aria-hidden'); els.loading.style.opacity = '1';

      setActive(id);
      els.currentTitle.textContent = item.title;
      localStorage.setItem(STORE.current, id);
      if (pushHash) history.replaceState(null, "", '#'+id);

      try{
        if (isInternalCertPage(id)){
          const html = await buildCertificatesPage();
          els.frame.srcdoc = html;
        } else if (isInternalIntroPage(id)){
          const html = await buildIntroPage();
          els.frame.srcdoc = html;
        } else {
          els.frame.removeAttribute('srcdoc');
          els.frame.src = item.url;
        }
      } catch(err){
        const safe = escapeHTML(String((err && err.message) ? err.message : err || 'Erro desconhecido'));
        els.frame.srcdoc = errorGenericHTML('N√£o foi poss√≠vel carregar o conte√∫do', safe);
      }

      // fechar menu mobile
      if (els.sidebar.classList.contains('open')) toggleMenu(false);
    }

    /* Spinner OFF quando iframe termina de carregar */
    els.frame.addEventListener('load', ()=>{
      els.loading.style.transition = 'opacity .35s ease';
      els.loading.style.opacity = '0';
      setTimeout(()=>els.loading.setAttribute('aria-hidden','true'), 360);
      const id = getCurrentId();
      const current = PAGES.find(p=>p.id===id);
      if (current) document.title = 'Portf√≥lio ‚Äî '+current.title;
    });

    /* ===== KEYBOARD ===== */
    window.addEventListener('keydown', (e)=>{
      const keyNum = Number(e.key);
      if (keyNum>=1 && keyNum<=9){
        const p = PAGES.find(pg=>pg.key===keyNum);
        if (p){
          const target = document.querySelector('.link[data-id="'+p.id+'"]');
          if (target){ target.focus(); loadPage(p.id); }
        }
        return;
      }
      const links = Array.from(document.querySelectorAll('.link'));
      const idx = links.findIndex(el=>el.classList.contains('active'));
      if (['ArrowDown','j','J'].includes(e.key)){
        const next = links[Math.min(idx+1, links.length-1)];
        if (next){ next.focus(); loadPage(next.dataset.id); }
      } else if (['ArrowUp','k','K'].includes(e.key)){
        const prev = links[Math.max(idx-1, 0)];
        if (prev){ prev.focus(); loadPage(prev.dataset.id); }
      } else if (e.key === 'Enter'){
        const active = links[idx] || links[0];
        if (active) loadPage(active.dataset.id);
      }
    });

    /* ===== TOOLBAR BUTTONS ===== */
    els.openNew.addEventListener('click', ()=>{
      const id = getCurrentId();
      const item = PAGES.find(p=>p.id===id);
      if (!item) return;
      if (isInternalCertPage(id)) window.open(CERTS_TXT, '_blank', 'noopener');
      else if (isInternalIntroPage(id)) window.open(KNOW_TXT, '_blank', 'noopener');
      else window.open(item.url, '_blank', 'noopener');
    });

    els.copyLink.addEventListener('click', async ()=>{
      const id = getCurrentId();
      const share = location.origin+location.pathname+'#'+id;
      try{
        await navigator.clipboard.writeText(share);
        els.copyLink.textContent = 'Copiado!';
        setTimeout(()=>els.copyLink.textContent='Copiar link', 1200);
      }catch{
        prompt('Copie o link:', share);
      }
    });

    // Recarregar + Hard reload
    els.reload.addEventListener('click', ()=>{
      const id = getCurrentId();
      const it = PAGES.find(p=>p.id===id);
      if (!it) return;
      if (isInternalCertPage(id)) {
        buildCertificatesPage().then(html=>{ els.frame.srcdoc = html; });
      } else if (isInternalIntroPage(id)) {
        buildIntroPage().then(html=>{ els.frame.srcdoc = html; });
      } else {
        try { els.frame.contentWindow.location.reload(); }
        catch { els.frame.src = it.url; }
      }
    });
    els.hardReload.addEventListener('click', ()=>{
      const id = getCurrentId();
      const it = PAGES.find(p=>p.id===id);
      if (!it) return;
      if (isInternalCertPage(id)) {
        buildCertificatesPage().then(html=>{ els.frame.srcdoc = html; });
      } else if (isInternalIntroPage(id)) {
        buildIntroPage().then(html=>{ els.frame.srcdoc = html; });
      } else {
        const base = (it.url||'').split('#')[0].split('?')[0];
        els.frame.removeAttribute('srcdoc');
        els.frame.src = base + '?ts=' + Date.now();
      }
    });

    /* ===== THEME TOGGLE ===== */
    function applyTheme(theme){
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem(STORE.theme, theme);
      const isDark = theme === 'dark';
      els.themeToggle.setAttribute('aria-pressed', String(isDark));
      els.themeToggle.textContent = 'Tema: ' + (isDark ? 'Escuro' : 'Claro');
    }
    function initTheme(){
      const saved = localStorage.getItem(STORE.theme);
      if (saved === 'dark' || saved === 'light'){
        applyTheme(saved);
      } else {
        applyTheme('dark');
      }
    }
    els.themeToggle.addEventListener('click', ()=>{
      const next = (document.body.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
      applyTheme(next);
      const cur = getCurrentId();
      if (isInternalCertPage(cur)) loadPage('certificados', false);
      if (isInternalIntroPage(cur)) loadPage('intro', false);
    });

    /* ===== MOBILE MENU ===== */
    function toggleMenu(force){
      const open = typeof force === 'boolean' ? force : !els.sidebar.classList.contains('open');
      els.sidebar.classList.toggle('open', open);
      els.burger?.setAttribute('aria-expanded', String(open));
    }
    els.burger?.addEventListener('click', ()=>toggleMenu());

    /* ===== SIDEBAR RESIZE ===== */
    (function sidebarResize(){
      const MIN = 240, MAX = 520;
      const saved = parseInt(localStorage.getItem(STORE.width)||'', 10);
      if (!Number.isNaN(saved)) els.sidebar.style.width = Math.max(MIN, Math.min(MAX, saved)) + 'px';

      let resizing = false;
      const onPointerMove = (e)=>{
        if (!resizing) return;
        const rect = els.sidebar.getBoundingClientRect();
        const newW = Math.max(MIN, Math.min(MAX, Math.round(e.clientX - rect.left)));
        els.sidebar.style.width = newW + 'px';
      };
      const stop = ()=>{
        if (!resizing) return;
        resizing = false;
        document.removeEventListener('pointermove', onPointerMove);
        document.removeEventListener('pointerup', stop);
        els.app.classList.remove('resizing');
        const w = parseInt(els.sidebar.style.width,10);
        if (!Number.isNaN(w)) localStorage.setItem(STORE.width, String(w));
      };
      els.resizer.addEventListener('pointerdown', (e)=>{
        if (window.matchMedia('(max-width: 860px)').matches) return;
        resizing = true; e.preventDefault();
        els.app.classList.add('resizing');
        document.addEventListener('pointermove', onPointerMove);
        document.addEventListener('pointerup', stop);
      });
      els.resizer.addEventListener('dblclick', ()=>{
        els.sidebar.style.width = '300px';
        localStorage.setItem(STORE.width, '300');
      });
    })();

    /* ===== UTIL ===== */
    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, function(m){
        return { "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m];
      });
    }

    function errorGenericHTML(title, msg){
      const theme = document.body.getAttribute('data-theme') || 'dark';
      return (
        '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'+
        '<title>Erro</title>'+
        '<style>'+
        'body[data-theme="dark"]{--bg:#0b0d12;--text:#e6ebf2;--muted:#97a0b0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui}'+
        'body[data-theme="light"]{--bg:#f5f7fb;--text:#0e1726;--muted:#5d6778;background:var(--bg);color:var(--text);font:14px/1.5 system-ui}'+
        '.wrap{max-width:900px;margin:0 auto;padding:18px} code{background:rgba(127,127,127,.15);padding:2px 6px;border-radius:6px} a{color:inherit}'+
        '</style></head><body data-theme="'+escapeHTML(theme)+'"><div class="wrap">'+
        '<h1>'+escapeHTML(title)+'</h1>'+
        '<p class="hint">Detalhe: <code>'+escapeHTML(msg)+'</code></p>'+
        '</div></body></html>'
      );
    }

    /* ===== CERTIFICADOS (SEM <script> dentro) ===== */
    async function buildCertificatesPage(){
      const theme = document.body.getAttribute('data-theme') || 'dark';
      const resp = await fetch(CERTS_TXT, { cache: 'no-cache' });
      if (!resp.ok) throw new Error('Falha ao carregar a lista ('+resp.status+')');
      const text = await resp.text();

      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const items = [];
      for (let i=0;i<lines.length;i++){
        const line = lines[i];
        const mPdf = line.match(/(?:^|\s)([^\s]+\.pdf)(?:\s|$)/i);
        if (!mPdf) continue;
        const pdfName = mPdf[1];
        const url = /^https?:\/\//i.test(pdfName) ? pdfName : (CERTS_BASE + pdfName);

        let desc = '';
        const mDescSpaced = line.match(/\s-\s(.*?)\s-\s/);
        if (mDescSpaced && mDescSpaced[1]) desc = mDescSpaced[1].trim();
        else {
          const mDescLoose = line.match(/-(.*?)-/);
          if (mDescLoose && mDescLoose[1]) desc = mDescLoose[1].trim();
        }
        const display = desc || decodeURIComponent(pdfName.replace(/^.*\//,'').replace(/\.pdf$/i,''));
        items.push({ url, display, tooltip: desc });
      }

      var cards = '';
      for (let i=0;i<items.length;i++){
        const it = items[i];
        const title = escapeHTML(it.tooltip || it.display);
        cards += ''
          + '<div class="card" title="'+title+'" style="background:linear-gradient(180deg,color-mix(in oklab,var(--panel) 85%,transparent),var(--panel));border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;align-items:center;gap:10px">'
          +   '<div class="icon" style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#21c97a);display:grid;place-items:center;color:#fff;font-weight:700">PDF</div>'
          +   '<div class="title" style="flex:1;min-width:0"><a href="'+escapeHTML(it.url)+'" title="'+title+'" target="_blank" rel="noopener" style="color:inherit;text-decoration:none">'+escapeHTML(it.display)+'</a></div>'
          + '</div>';
      }

      const css =
        'html,body{height:100%}'+
        'body[data-theme="dark"]{--bg:#0b0d12;--panel:#0f131b;--text:#e6ebf2;--muted:#97a0b0;--accent:#00e0ff;--border:#1a2230;--soft:#111826;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans"}'+
        'body[data-theme="light"]{--bg:#f5f7fb;--panel:#ffffff;--text:#0e1726;--muted:#5d6778;--accent:#007bff;--border:#dfe6ee;--soft:#f2f6fb;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans"}'+
        '.wrap{max-width:1100px;margin:0 auto;padding:18px}'+
        'h1{margin:0 0 8px 0;font-size:16px}'+
        'p.sub{margin:0 0 16px 0;color:var(--muted)}'+
        '.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}'+
        '.hint{color:var(--muted);font-size:12px;margin-top:8px}';

      const doc =
        '<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8">'+
        '<meta name="viewport" content="width=device-width, initial-scale=1">'+
        '<title>Certificados</title><style>'+css+'</style></head>'+
        '<body data-theme="'+escapeHTML(theme)+'"><div class="wrap">'+
        '<h1>Certificados</h1>'+
        '<p class="sub">Passe o mouse para ver a descri√ß√£o (entre h√≠fens) como dica de ferramenta.</p>'+
        (items.length ? '<div class="grid">'+cards+'</div>' : '<p class="hint">Nenhum PDF encontrado em <code>CertificadosList.txt</code>. Verifique o conte√∫do.</p>')+
        '<p class="hint">Fonte: <a href="'+escapeHTML(CERTS_TXT)+'" target="_blank" rel="noopener">CertificadosList.txt</a></p>'+
        '</div></body></html>';

      return doc;
    }

    /* ===== INTRO (l√™ KnowledgeList.txt; pega texto depois de ||) ===== */
    async function buildIntroPage(){
      const theme = document.body.getAttribute('data-theme') || 'dark';
      const resp = await fetch(KNOW_TXT, { cache: 'no-cache' });
      if (!resp.ok) throw new Error('Falha ao carregar KnowledgeList ('+resp.status+')');
      const text = await resp.text();

      const lines = text.split(/\r?\n/);
      const items = [];
      for (let i=0;i<lines.length;i++){
        const raw = (lines[i]||'').trim();
        if (!raw || raw.startsWith('#')) continue; // ignora vazio e coment√°rio
        const parts = raw.split('||');
        if (parts.length < 2) continue;
        const after = parts.slice(1).join('||').trim(); // tudo ap√≥s o primeiro ||
        if (after) items.push(after);
      }

      // monta lista
      let lis = '';
      for (let i=0;i<items.length;i++){
        lis += '<li>'+escapeHTML(items[i])+'</li>';
      }

      const css =
        'html,body{height:100%}'+
        'body[data-theme="dark"]{--bg:#0b0d12;--panel:#0f131b;--text:#e6ebf2;--muted:#97a0b0;--accent:#00e0ff;--border:#1a2230;--soft:#111826;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans"}'+
        'body[data-theme="light"]{--bg:#f5f7fb;--panel:#ffffff;--text:#0e1726;--muted:#5d6778;--accent:#007bff;--border:#dfe6ee;--soft:#f2f6fb;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans"}'+
        '.wrap{max-width:1000px;margin:0 auto;padding:24px}'+
        '.hero{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px}'+
        '.title{font-size:22px;margin:0}'+
        '.muted{color:var(--muted)}'+
        '.glass{background: color-mix(in oklab, var(--panel) 70%, transparent); border:1px solid var(--border); border-radius:16px; padding:16px;'+
          'box-shadow:0 8px 30px rgba(0,0,0,.15);'+
          'backdrop-filter: blur(12px) saturate(140%) brightness(1.05); -webkit-backdrop-filter: blur(12px) saturate(140%) brightness(1.05);}'+
        '.btn{display:inline-block;padding:10px 14px;border-radius:12px;border:1px solid color-mix(in oklab, var(--border) 80%, transparent);'+
          'text-decoration:none;color:inherit;background:linear-gradient(180deg, color-mix(in oklab, var(--soft) 70%, transparent), transparent);'+
          'box-shadow: inset 0 0 0 1px color-mix(in oklab, var(--accent) 20%, transparent);}'+
        'ul{margin:0;padding-left:20px}'+
        'li{margin:6px 0}';

      const backHref = '#'+encodeURIComponent(INTRO_BACK_TARGET);

      const doc =
        '<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8">'+
        '<meta name="viewport" content="width=device-width, initial-scale=1">'+
        '<title>Intro</title><style>'+css+'</style></head>'+
        '<body data-theme="'+escapeHTML(theme)+'">'+
        '<div class="wrap">'+
          '<div class="hero">'+
            '<h1 class="title">Intro <span class="muted">‚Äî Knowledge List</span></h1>'+
            '<a class="btn" href="'+backHref+'" target="_top" rel="noopener">‚üµ Back to Resume</a>'+
          '</div>'+
          '<div class="glass">'+
            (items.length ? ('<ul>'+lis+'</ul>') : '<p class="muted">Nenhuma linha v√°lida encontrada ap√≥s <code>||</code>.</p>')+
          '</div>'+
          '<p class="muted" style="margin-top:10px">Fonte: <a href="'+escapeHTML(KNOW_TXT)+'" target="_blank" rel="noopener">'+escapeHTML(KNOW_TXT)+'</a></p>'+
        '</div>'+
        '</body></html>';

      return doc;
    }

    /* ===== INIT ===== */
    renderMenu();
    attachMenuFilter();
    initTheme();

    window.addEventListener('hashchange', ()=>{
      const id = getCurrentId();
      loadPage(id, false);
    });
    loadPage(getCurrentId());

    /* WATCHDOG anti-iframe bloqueado */
    (function watchdog(){
      let ok = false;
      function mark(){ ok = true; }
      els.frame.addEventListener('load', mark, { once:true });
      setInterval(()=>{
        if (ok) return;
        if (document.getElementById('wdg-overlay')) return;
        const overlay = document.createElement('div');
        overlay.id = 'wdg-overlay';
        overlay.style.cssText = 'position:absolute;inset:0;display:grid;place-items:center;padding:24px;'+
          'background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 85%, transparent), var(--panel));'+
          'border-top:1px solid var(--border);color:var(--muted);text-align:center';
        const id = getCurrentId();
        overlay.innerHTML = '<div style="max-width:720px">'+
          '<h2 style="margin:0 0 8px;color:var(--text);font-size:16px">N√£o foi poss√≠vel exibir dentro do iframe</h2>'+
          '<p style="margin:0 0 12px">Alguns sites bloqueiam incorpora√ß√£o (X-Frame-Options). Abra em nova aba.</p>'+
          '<button id="wdg-open" class="btn">Abrir em nova aba</button></div>';
        els.frame.parentElement.appendChild(overlay);
        document.getElementById('wdg-open').addEventListener('click', ()=>{
          const it = PAGES.find(p=>p.id===id);
          if (!it) return;
          if (isInternalCertPage(id)) window.open(CERTS_TXT, '_blank', 'noopener');
          else if (isInternalIntroPage(id)) window.open(KNOW_TXT, '_blank', 'noopener');
          else window.open(it.url, '_blank', 'noopener');
        });
      }, 2500);
    })();
  </script>

  <!-- SVG filter p/ WATER TEXT -->
  <svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px">
    <filter id="aab-water-ripple">
      <feTurbulence type="fractalNoise" baseFrequency="0.007 0.012" numOctaves="2" seed="7" result="noise">
        <animate attributeName="baseFrequency" dur="8s" values="0.007 0.012; 0.010 0.016; 0.007 0.012" repeatCount="indefinite"/>
      </feTurbulence>
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="6" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </svg>
</body>
</html>
