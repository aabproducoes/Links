<!-- Main Script -->
<script>
  let selectedLanguage = 'en'; // Default language

  window.addEventListener('DOMContentLoaded', () => {
    changeLanguage(); // Initialize language
    fetchKnowledgeList(); // Load Knowledge List
    fetchCertificationsList(); // Load Certifications List
  });

  function changeLanguage() {
    const languageSelect = document.getElementById("language");
    selectedLanguage = languageSelect.value;
    fetchTranslations();
    fetchKnowledgeList();
    fetchCertificationsList();
  }

  function fetchTranslations() {
    const translationFile = `./translations/translations_${selectedLanguage}.json`;

    fetch(translationFile)
      .then(response => {
        if (!response.ok) {
          throw new Error(`Failed to fetch translations: ${response.status} ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log(`Loaded translations for ${selectedLanguage}:`, data);
        // Update section titles
        document.getElementById("socialLinks").innerText = data.socialLinks || "Social Links & Projects";
        document.getElementById("friendlySites").innerText = data.friendlySites || "Friendly Sites";
        document.getElementById("certifications").innerText = data.certifications || "Certifications";
        document.getElementById("contact").innerText = data.contact || "Contact";
        document.getElementById("knowledge-title").innerText = data.knowledge || "Knowledge";

        // Update language selector label
        const languageLabel = document.querySelector('.language-selector label');
        if (languageLabel) {
          languageLabel.innerText = data.selectlanguage || "Select Language:";
        }

        // Update project links
        const projectLinks = document.querySelectorAll('.project-links a');
        projectLinks.forEach(link => {
          const key = link.textContent.replace(/\s+/g, '').toLowerCase();
          if (data[key]) {
            link.textContent = data[key];
          }
        });

        // Update friendly sites links
        const friendlySitesLinks = document.querySelectorAll('.friendly-sites a');
        friendlySitesLinks.forEach(link => {
          const key = link.textContent.replace(/\s+/g, '').toLowerCase();
          if (data[key]) {
            link.textContent = data[key];
          }
        });

        // Update Contact links
        const contactLinks = document.querySelectorAll('.center-section p a');
        contactLinks.forEach(link => {
          if (link.href.startsWith("https://wa.me/")) {
            link.textContent = `${data.whatsapp || "WhatsApp"}: 54984181968`;
          } else if (link.href.startsWith("mailto:")) {
            link.textContent = `${data.email || "Email"}: aaugusto444@gmail.com`;
          }
        });
      })
      .catch(error => {
        console.error('Error fetching translation file:', error);
        // Fallback to default titles if there's an error
        document.getElementById("socialLinks").innerText = "Social Links & Projects";
        document.getElementById("friendlySites").innerText = "Friendly Sites";
        document.getElementById("certifications").innerText = "Certifications";
        document.getElementById("contact").innerText = "Contact";
        document.getElementById("knowledge-title").innerText = "Knowledge";

        // Fallback for language selector label
        const languageLabel = document.querySelector('.language-selector label');
        if (languageLabel) {
          languageLabel.innerText = "Select Language:";
        }
      });
  }

  function fetchKnowledgeList() {
    fetch('./KnowledgeList/KnowledgeList.txt')
      .then(response => response.text())
      .then(data => {
        const knowledgeList = document.getElementById("knowledge-list");
        knowledgeList.innerHTML = ''; // Clear the current list

        const lines = data.split('\n').filter(line => line.trim() !== '');
        lines.forEach(line => {
          const [enText, ptText] = line.split('||'); // Split the text by "||"
          const listItem = document.createElement('li');
          listItem.textContent = selectedLanguage === 'pt' ? (ptText ? ptText.trim() : '') : (enText ? enText.trim() : '');
          knowledgeList.appendChild(listItem);
        });
      })
      .catch(error => console.error('Error loading knowledge list:', error));
  }

  async function fetchCertificationsList() {
    try {
      const response = await fetch('./Certificados/CertificadosList.txt');
      if (!response.ok) {
        throw new Error(`Failed to fetch certifications list: ${response.status} ${response.statusText}`);
      }

      const data = await response.text();
      const certificationsList = document.getElementById("certifications-list");
      certificationsList.innerHTML = ''; // Clear existing list

      const lines = data.split('\n').filter(line => line.trim() !== ''); // Remove empty lines
      lines.forEach(line => {
        // Ensure the line has both a file part and title part
        const [filePart, titlePart] = line.split(':');
        if (filePart && titlePart) {
          const file = filePart.trim().replace(/["']/g, ''); // Remove quotes from file name
          const titles = titlePart.split('||');

          // Trim titles and set default titles only if missing
          const enTitle = (titles[0] && titles[0].trim()) || "Untitled Certification";
          const ptTitle = (titles[1] && titles[1].trim()) || "Certificação Sem Título";

          const listItem = document.createElement('li');

          // Certification Title
          const certTitle = document.createElement('div');
          certTitle.classList.add('cert-title');
          certTitle.textContent = selectedLanguage === 'pt' ? ptTitle : enTitle;

          // PDF Canvas
          const pdfCanvas = document.createElement('canvas');
          pdfCanvas.classList.add('pdf-canvas');
          pdfCanvas.id = `pdf-canvas-${file}`; // Unique ID for each canvas

          listItem.appendChild(certTitle);
          listItem.appendChild(pdfCanvas);
          certificationsList.appendChild(listItem);

          // Render the first page of the PDF
          renderFirstPage(`./Certificados/${file}`, pdfCanvas.id);
        }
      });
    } catch (error) {
      console.error('Error loading certifications list:', error);
      alert('An error occurred while loading the certifications list. Please try again later.');
    }
  }

  function renderFirstPage(pdfUrl, canvasId) {
    const canvas = document.getElementById(canvasId);
    const context = canvas.getContext('2d');

    pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
      pdf.getPage(1).then(page => {
        const scale = 1.5; // Adjust the scale for better resolution
        const viewport = page.getViewport({ scale });

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        const renderContext = {
          canvasContext: context,
          viewport: viewport
        };
        page.render(renderContext);
      });
    }).catch(error => {
      console.error(`Error rendering first page of PDF ${pdfUrl}:`, error);
    });
  }
</script>
