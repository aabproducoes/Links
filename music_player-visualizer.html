<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Visualizer — presets use RIGHT picker, buttons use LEFT picker</title>
<style>
/* ───────── layout / controls ───────── */
html,body{margin:0;padding:0;overflow:hidden;background:#000;height:100%;
          font-family:Arial,Helvetica,sans-serif}
#controls{position:absolute;top:10px;left:50%;transform:translateX(-50%);
          z-index:10;color:#fff;text-align:center}
.top-row{display:flex;align-items:center;gap:10px;margin-bottom:5px}
#visualizationSelect,#fileName{font-size:16px}
#playlistSelect{margin:5px 0;font-size:16px;padding:2px}

/* transport bar */
.music-controls{display:inline-flex;align-items:center;gap:6px;margin:5px 0}
.music-controls button{
  background:transparent;border:none;cursor:pointer;padding:4px;
  color:#00ff00;                                /* default, will be overwritten */
}
.music-controls svg{width:28px;height:28px;vertical-align:middle}
#progress,#volume{background:transparent;accent-color:#00ff00}
#progress{width:200px} #volume{width:80px}
#shuffleBtn{background:transparent;border:none;cursor:pointer;opacity:.4}
#shuffleBtn svg{width:26px;height:26px;vertical-align:middle}

/* colour pickers */
#colorControls{display:flex;gap:40px;justify-content:center;margin-top:10px}
.color-group{display:flex;align-items:center;gap:5px}
.color-container{display:inline-flex;gap:5px;flex-wrap:wrap}
.color-item{display:flex;align-items:center;gap:2px}
.color-item input[type=color]{width:30px;height:30px;border:none;background:transparent}
.color-item button,.add-color{background:transparent;border:none;color:#fff;font-size:16px;cursor:pointer}
.add-color{border:1px solid #fff;padding:2px 6px;margin-left:5px}

/* eq sliders */
#equalizerControls{margin-top:10px;display:flex;flex-direction:column;align-items:center;
                   background:rgba(0,0,0,.7);padding:10px;border-radius:5px}
.eq-sliders{display:flex;gap:10px}
.eq-slider{display:flex;flex-direction:column;align-items:center;font-size:12px}
.eq-slider input[type=range]{width:8px;height:100px;padding:0 5px;
                              transform:rotate(-90deg);-webkit-appearance:none}
@supports (-webkit-appearance:slider-vertical){
  .eq-slider input[type=range]{transform:none;-webkit-appearance:slider-vertical}
}

/* drag feedback */
.drop-highlight-green{animation:blinkGreen 1s infinite}
.drop-highlight-red  {animation:blinkRed  1s infinite}
@keyframes blinkGreen{0%{outline:5px solid lime}50%{outline:5px solid transparent}100%{outline:5px solid lime}}
@keyframes blinkRed  {0%{outline:5px solid red} 50%{outline:5px solid transparent}100%{outline:5px solid red}}

/* misc */
#configRow{margin-top:10px}
#configRow button{font-size:16px;padding:4px 8px;cursor:pointer}
#helpText{margin-top:10px;font-size:14px;background:rgba(0,0,0,.7);
          padding:10px;border-radius:5px;max-width:400px}
#visualizerCanvas{display:block;position:absolute;top:0;left:0}
@media(max-width:680px){
  #controls{position:static;transform:none;padding:10px}
  .top-row{flex-direction:column}
}
</style>
</head>
<body>

<!-- ───────── controls ───────── -->
<div id="controls">
  <div class="top-row">
    <select id="visualizationSelect">
      <option value="bars">Bars</option><option value="waves">Waves</option>
      <option value="circles">Circles</option><option value="pattern1">Pattern 1</option>
      <option value="pattern2">Pattern 2</option><option value="radial">Radial</option>
      <option value="spiral">Spiral</option><option value="equalizer">Equalizer</option>
      <option value="waveform">Waveform</option><option value="dots">Dots</option>
      <option value="symmetricBars">Symmetric Bars</option>
      <option value="symmetricWaves">Symmetric Waves</option>
      <option value="symmetricCircles">Symmetric Circles</option>
      <option value="stereoBars">Stereo Bars</option>
      <option value="stereoWaves">Stereo Waves</option>
      <option value="stereoCircles">Stereo Circles</option>
      <option value="treeFractal">Tree Fractal</option>
    </select>
    <span id="fileName"></span>
  </div>

  <select id="playlistSelect"></select>

  <div class="music-controls">
    <button id="prevBtn" title="Previous">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <polygon points="11,19 11,5 4,12"/><polygon points="20,19 20,5 13,12"/>
      </svg>
    </button>

    <button id="playBtn" title="Play">
      <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <polygon points="8,5 19,12 8,19"/>
      </svg>
    </button>

    <button id="stopBtn" title="Stop">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <rect x="6" y="6" width="12" height="12"/>
      </svg>
    </button>

    <button id="nextBtn" title="Next">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <polygon points="4,19 4,5 11,12"/><polygon points="13,19 13,5 20,12"/>
      </svg>
    </button>

    <input id="progress" type="range" min="0" max="100" step="0.1" value="0" title="Seek">
    <input id="volume"   type="range" min="0" max="1"   step="0.01" value="1" title="Volume">

    <button id="shuffleBtn" title="Shuffle">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
           fill="none" stroke="currentColor" stroke-width="2">
        <path d="M16 3h5v5M3 16l6-6 7 7 6-6"/>
      </svg>
    </button>
  </div>

  <div id="colorControls">
    <div class="color-group">
      <span>Main Colors:</span><div id="visualizerColors" class="color-container"></div>
      <button id="addVisualizerColor" class="add-color">+</button>
    </div>
    <div class="color-group">
      <span>Border Colors:</span><div id="borderColors" class="color-container"></div>
      <button id="addBorderColor" class="add-color">+</button>
    </div>
  </div>

  <div id="configRow">
    <button id="saveConfigFile">Save Config</button>
    <button id="loadConfigFile">Load Config</button>
    <input type="file" id="configFileInput" accept=".txt" style="display:none">
  </div>

  <div id="equalizerControls"><h3>Equalizer</h3><div id="eqSliders" class="eq-sliders"></div></div>
  <div id="helpText"><p><strong>Drag & Drop:</strong> drop local *.mp3* files or a *.txt* list of MP3 URLs anywhere to add them.</p></div>
</div>

<canvas id="visualizerCanvas"></canvas>
<audio  id="audio" crossorigin="anonymous"></audio>

<!-- ───────── script ───────── -->
<script>
/* (1) playlist — 15 Archive.org NCS tracks */
let playlist=[
  {name:"DEAF KEV – Invincible",url:"https://archive.org/download/deaf-kev-invincible-ncs-release_202403/DEAF%20KEV%20-%20Invincible%20%5BNCS%20Release%5D.mp3"},
  {name:"Cartoon – On & On (ft Daniel Levi)",url:"https://archive.org/download/CartoonOnOnft.DanielLevi/Cartoon%20-%20On%20%26%20On%20%28ft.%20Daniel%20Levi%29.mp3"},
  {name:"Disfigure – Blank",url:"https://archive.org/download/warriyo-mortals-feat.-laura-brehm-ncs-release/Disfigure%20-%20Blank%20%5BNCS%20Release%5D.mp3"},
  {name:"Alan Walker – Fade",url:"https://archive.org/download/alan-walker-fade-ncs-release-video/Alan%20Walker%20-%20Fade%20%5BNCS%20Release%5D.webm"},
  {name:"Alan Walker – Force",url:"https://archive.org/download/alan-walker-force-ncs-release-audio/Alan%20Walker%20-%20Force%20%5BNCS%20Release%5D.mp3"},
  {name:"Egzod & Neoni – Royalty",url:"https://archive.org/download/soundcloud-1013787601/Egzod%20%26%20Maestro%20Chives%20%26%20Neoni%20-%20Royalty%20%5BNCS%20Release%5D.mp3"},
  {name:"Glude – Dreamers",url:"https://archive.org/download/Chrisnfugo/Glude%20-%20Dreamers%20%5BNCS%20Release%5D.mp3"},
  {name:"HYLO – Paradise (ft Akacia)",url:"https://archive.org/download/Chrisnfugo/HYLO%20-%20Paradise%20ft.%20Akacia%20%5BNCS%20Release%5D.mp3"},
  {name:"Feint – Shockwave (ft Heather Sommer)",url:"https://archive.org/download/Chrisnfugo/Feint%20-%20Shockwave%20%28feat.%20Heather%20Sommer%29.mp3"},
  {name:"Focus Fire – Mirage",url:"https://archive.org/download/Chrisnfugo/Focus%20Fire%20-%20Mirage.mp3"},
  {name:"JPB – All Stops Now (ft Soundr)",url:"https://archive.org/download/Chrisnfugo/JPB%20-%20All%20Stops%20Now%20%28feat.%20Soundr%29%20%5BNCS%20Release%5D.mp3"},
  {name:"Heuse & Chris Linton – Reactive",url:"https://archive.org/download/Chrisnfugo/Heuse%20%26%20Chris%20Linton%20-%20Reactive.mp3"},
  {name:"Mo Falk & OVSKY – Home",url:"https://archive.org/download/NoCopyrightSounds/Mo%20Falk%20%26%20OVSKY%20-%20Home%20%5BNCS%20Release%5D.mp3"},
  {name:"OVSKY – Time",url:"https://archive.org/download/NoCopyrightSounds/OVSKY%20-%20Time%20%5BNCS%20Release%5D.mp3"},
  {name:"Focus Fire – Reason",url:"https://archive.org/download/NoCopyrightSounds/Floatinurboat%20x%20Chris%20Linton%20-%20Holding%20On.mp3"}
];
let currentTrackIndex=0,shuffle=false;

/* (2) shorthand & gradients */
const $=id=>document.getElementById(id);
function gradOf(nodes){
  const c=[...nodes].map(n=>n.value);
  if(c.length<2) return c[0]||"#00ff00";
  const g=ctx.createLinearGradient(0,0,WIDTH,HEIGHT);
  c.forEach((v,i)=>g.addColorStop(i/(c.length-1),v));
  return g;
}
const getVizColor  =()=>gradOf(document.querySelectorAll('#borderColors input[type=color]')); // right picker
const mainPickerFirst =()=>{const n=document.querySelector('#visualizerColors input[type=color]');return n?n.value:"#00ff00";}
function updateIconColors(){document.querySelectorAll('.music-controls button').forEach(b=>b.style.color=mainPickerFirst());}

/* colour‑picker factory */
function makeColor(initial){
  const d=document.createElement('div');d.className='color-item';
  const i=document.createElement('input');i.type='color';i.value=initial;i.oninput=i.onchange=updateIconColors;
  const x=document.createElement('button');x.textContent='×';x.onclick=()=>{if(d.parentElement.children.length>1){d.remove();updateIconColors();}};
  d.append(i,x);return d;
}
/* init pickers */
$('visualizerColors').appendChild(makeColor("#00ff00"));
$('borderColors')   .appendChild(makeColor("#00ff00"));
$('addVisualizerColor').onclick=()=>{$('visualizerColors').appendChild(makeColor("#00ff00"));updateIconColors();}
$('addBorderColor') .onclick=()=> $('borderColors').appendChild(makeColor("#00ff00"));

/* (3) canvas dims */
const canvas=$('visualizerCanvas'),ctx=canvas.getContext('2d');let WIDTH,HEIGHT;
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;WIDTH=canvas.width;HEIGHT=canvas.height;}
onresize=resize;resize();

/* (4) Audio context, analyser, EQ (same logic as before) */
const audio=$('audio');let audioCtx,source,analyser,dataArray,leftData,rightData,filters=[];
function initAudio(){
  if(audioCtx)return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  source=audioCtx.createMediaElementSource(audio);
  const freqs=[60,170,310,600,1000,3000,6000,12000];
  filters=freqs.map(f=>{const b=audioCtx.createBiquadFilter();b.type=f<=1000?'peaking':'highshelf';b.frequency.value=f;return b;});
  let last=source;filters.forEach(f=>{last.connect(f);last=f;});
  analyser=audioCtx.createAnalyser();analyser.fftSize=512;last.connect(analyser);
  const buf=new Uint8Array(analyser.frequencyBinCount);dataArray=buf;leftData=buf.subarray(0,buf.length>>1);rightData=buf.subarray(buf.length>>1);
  last.connect(audioCtx.destination);buildEQ();
}
function buildEQ(){
  const box=$('eqSliders');if(box.children.length)return;const lbl=['60','170','310','600','1k','3k','6k','12k'];
  filters.forEach((f,i)=>{const w=document.createElement('div');w.className='eq-slider';
    const r=document.createElement('input');r.type='range';r.min=-12;r.max=12;r.step=.1;r.value=0;r.oninput=()=>f.gain.value=r.value;
    const l=document.createElement('span');l.textContent=lbl[i];w.append(r,l);box.appendChild(w);});
}

/* (5) visualizers — ALL use getVizColor() */
const V=getVizColor;   /* shorthand */
const vis={
  bars:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);const bw=(WIDTH/d.length)*2.5;for(let i=0,x=0;i<d.length;i++,x+=bw+1){ctx.fillStyle=V();ctx.fillRect(x,HEIGHT-d[i],bw,d[i]);}},
  waves:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);ctx.beginPath();ctx.moveTo(0,HEIGHT/2);for(let i=0;i<d.length;i++){ctx.lineTo(i*(WIDTH/d.length),HEIGHT/2+d[i]-128);}ctx.strokeStyle=V();ctx.stroke();},
  circles:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);const R=Math.min(WIDTH,HEIGHT)/4;for(const v of d){ctx.beginPath();ctx.arc(WIDTH/2,HEIGHT/2,v/255*R,0,2*Math.PI);ctx.strokeStyle=V();ctx.stroke();}},
  pattern1:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);for(let i=0;i<d.length;i++){ctx.fillStyle=V();ctx.fillRect((i%10)*(WIDTH/10),Math.floor(i/10)*(HEIGHT/10),(d[i]/255)*(WIDTH/20),(d[i]/255)*(WIDTH/20));}},
  pattern2:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);for(let i=0;i<d.length;i++){ctx.beginPath();const r=d[i]/255*Math.min(WIDTH,HEIGHT)/3,a=i/d.length*2*Math.PI;ctx.arc(WIDTH/2+r*Math.cos(a),HEIGHT/2+r*Math.sin(a),5,0,2*Math.PI);ctx.fillStyle=V();ctx.fill();}},
  radial:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);const cx=WIDTH/2,cy=HEIGHT/2,R=Math.min(WIDTH,HEIGHT)/4;for(let i=0;i<d.length;i++){ctx.beginPath();const h=d[i]/255*100,a=i/d.length*2*Math.PI;ctx.moveTo(cx+R*Math.cos(a),cy+R*Math.sin(a));ctx.lineTo(cx+(R+h)*Math.cos(a),cy+(R+h)*Math.sin(a));ctx.strokeStyle=V();ctx.stroke();}},
  spiral:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);ctx.beginPath();let a=0,r=0;for(const v of d){a+=.3;r+=v/255*2;ctx.lineTo(WIDTH/2+r*Math.cos(a),HEIGHT/2+r*Math.sin(a));}ctx.strokeStyle=V();ctx.stroke();},
  equalizer:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);const bw=WIDTH/d.length;for(let i=0;i<d.length;i++){ctx.fillStyle=V();ctx.fillRect(i*bw,HEIGHT-d[i]/255*HEIGHT,bw-2,d[i]/255*HEIGHT);}},
  waveform:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);ctx.beginPath();const sw=WIDTH/d.length;for(let i=0,x=0;i<d.length;i++,x+=sw){const y=d[i]/128*HEIGHT/2;i?ctx.lineTo(x,y):ctx.moveTo(x,y);}ctx.strokeStyle=V();ctx.stroke();},
  dots:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);for(const v of d){ctx.beginPath();ctx.arc(Math.random()*WIDTH,Math.random()*HEIGHT,v/255*10,0,2*Math.PI);ctx.fillStyle=V();ctx.fill();}},

  symmetricBars:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);const half=WIDTH/2,bw=(half/d.length)*2.5;for(let i=0;i<d.length;i++){ctx.fillStyle=V();ctx.fillRect(i*(bw+1),HEIGHT-d[i],bw,d[i]);ctx.fillRect(WIDTH-i*(bw+1)-bw,HEIGHT-d[i],bw,d[i]);}},
  symmetricWaves:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);ctx.beginPath();const half=d.length>>1,step=WIDTH/2/half;for(let i=0;i<half;i++){ctx.lineTo(i*step,HEIGHT/2+d[i]-128);}for(let i=half-1;i>=0;i--){ctx.lineTo(WIDTH-((i+1)*step),HEIGHT/2+d[i]-128);}ctx.strokeStyle=V();ctx.stroke();},
  symmetricCircles:d=>{ctx.clearRect(0,0,WIDTH,HEIGHT);const R=Math.min(WIDTH,HEIGHT)/4;for(let i=0;i<d.length;i++){const r=d[i]/255*R,a=i/d.length*Math.PI;ctx.beginPath();ctx.arc(WIDTH/4+Math.cos(a)*r,HEIGHT/2+Math.sin(a)*r,r/4,0,2*Math.PI);ctx.strokeStyle=V();ctx.stroke();ctx.beginPath();ctx.arc(3*WIDTH/4+Math.cos(a)*r,HEIGHT/2+Math.sin(a)*r,r/4,0,2*Math.PI);ctx.stroke();}},

  stereoBars:()=>{ctx.clearRect(0,0,WIDTH,HEIGHT);const bw=(WIDTH/2/leftData.length)*2.5;for(let i=0,x=0;i<leftData.length;i++,x+=bw+1){ctx.fillStyle=V();ctx.fillRect(x,HEIGHT-leftData[i],bw,leftData[i]);}for(let i=0,x=WIDTH/2;i<rightData.length;i++,x+=bw+1){ctx.fillRect(x,HEIGHT-rightData[i],bw,rightData[i]);}},
  stereoWaves:()=>{ctx.clearRect(0,0,WIDTH,HEIGHT);ctx.beginPath();const step=WIDTH/leftData.length;for(let i=0,x=0;i<leftData.length;i++,x+=step)ctx.lineTo(x,HEIGHT/2*(1-leftData[i]/255));ctx.strokeStyle=V();ctx.stroke();ctx.beginPath();for(let i=0,x=0;i<rightData.length;i++,x+=step)ctx.lineTo(x,HEIGHT/2+(HEIGHT/2)*(1-rightData[i]/255));ctx.stroke();},
  stereoCircles:()=>{ctx.clearRect(0,0,WIDTH,HEIGHT);const R=Math.min(WIDTH/2,HEIGHT)/4,len=leftData.length;for(let i=0;i<len;i++){const rL=leftData[i]/255*R,a=i/len*2*Math.PI;ctx.beginPath();ctx.arc(WIDTH/4+Math.cos(a)*rL,HEIGHT/2+Math.sin(a)*rL,rL/2,0,2*Math.PI);ctx.strokeStyle=V();ctx.stroke();const rR=rightData[i]/255*R;ctx.beginPath();ctx.arc(3*WIDTH/4+Math.cos(a)*rR,HEIGHT/2+Math.sin(a)*rR,rR/2,0,2*Math.PI);ctx.stroke();}},

  treeFractal:d=>{
    const amp=d.reduce((a,b)=>a+b,0)/(d.length*255);ctx.clearRect(0,0,WIDTH,HEIGHT);
    ctx.save();ctx.translate(WIDTH/2,HEIGHT);draw(HEIGHT*0.25+amp*HEIGHT*0.25,Math.PI/4,9);ctx.restore();
    function draw(len,ang,dep){if(dep===0||len<2)return;ctx.strokeStyle=V();ctx.lineWidth=Math.max(1,dep/2);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,-len);ctx.stroke();ctx.translate(0,-len);
      const sway=(amp-0.5)*0.8;ctx.save();ctx.rotate(ang+sway);draw(len*(0.7+amp*0.15),ang,dep-1);ctx.restore();ctx.save();ctx.rotate(-ang+sway);draw(len*(0.7+amp*0.15),ang,dep-1);ctx.restore();}
  }
};

/* (6) animation */
let currentViz=$('visualizationSelect').value;
$('visualizationSelect').onchange=e=>currentViz=e.target.value;
function animate(){if(analyser){analyser.getByteFrequencyData(dataArray);currentViz.startsWith('stereo')?vis[currentViz]():vis[currentViz](dataArray);}requestAnimationFrame(animate);}
audio.onplay=()=>{initAudio();animate();updateIconColors();}
audio.onpause=updateIconColors;

/* (7) playlist selector */
const playlistSelect=$('playlistSelect');
function refreshSelect(){playlistSelect.innerHTML='';playlist.forEach((t,i)=>{const o=document.createElement('option');o.value=i;o.textContent=t.name;playlistSelect.appendChild(o);});playlistSelect.selectedIndex=currentTrackIndex;}
playlistSelect.onchange=function(){currentTrackIndex=+this.value;loadTrack(currentTrackIndex);audio.play();}
refreshSelect();

/* (8) transport */
function loadTrack(i){currentTrackIndex=i;$('fileName').textContent=playlist[i].name;audio.src=playlist[i].url;refreshSelect();setPlayIcon();}
function setPlayIcon(){$('playBtn').innerHTML=
 audio.paused?'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><polygon points="8,5 19,12 8,19"/></svg>'
            :'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>';updateIconColors();}
$('prevBtn').onclick=()=>{currentTrackIndex=(currentTrackIndex-1+playlist.length)%playlist.length;loadTrack(currentTrackIndex);audio.play();}
$('playBtn').onclick=()=>{audio.paused?audio.play():audio.pause();setPlayIcon();}
$('stopBtn').onclick=()=>{audio.pause();audio.currentTime=0;setPlayIcon();}
$('nextBtn').onclick=()=>next(false);audio.onended=()=>next(true);
$('shuffleBtn').onclick=()=>{shuffle=!shuffle;$('shuffleBtn').style.opacity=shuffle?1:.4;}
function next(auto){
  if(shuffle&&auto){let n;do{n=Math.random()*playlist.length|0;}while(n===currentTrackIndex);currentTrackIndex=n;}
  else currentTrackIndex=(currentTrackIndex+1)%playlist.length;
  loadTrack(currentTrackIndex);audio.play();
}
$('volume').oninput=e=>audio.volume=e.target.value;
const progress=$('progress');
audio.ontimeupdate=()=>{if(!progress.dragging&&audio.duration)progress.value=(audio.currentTime/audio.duration)*100;}
progress.oninput=()=>progress.dragging=true;
progress.onchange=()=>{audio.currentTime=(progress.value/100)*audio.duration;progress.dragging=false;}

/* (9) drag‑and‑drop */
document.ondragover=e=>{e.preventDefault();const f=e.dataTransfer.items[0]?.getAsFile(),ok=f&&(f.type.startsWith('audio/')||f.name.endsWith('.txt'));document.body.classList.toggle('drop-highlight-green',ok);document.body.classList.toggle('drop-highlight-red',!ok);};
document.ondragleave=e=>{e.preventDefault();document.body.classList.remove('drop-highlight-green','drop-highlight-red');};
document.ondrop=e=>{
  e.preventDefault();document.body.classList.remove('drop-highlight-green','drop-highlight-red');
  if(!e.dataTransfer.files.length)return;
  const files=[...e.dataTransfer.files];let added=[];
  files.forEach(f=>{
    if(f.type.startsWith('audio/')) added.push({name:f.name,url:URL.createObjectURL(f)});
    else if(f.name.toLowerCase().endsWith('.txt')){
      const r=new FileReader();r.onload=ev=>{ev.target.result.split(/\r?\n/).forEach(l=>{const u=l.trim();if(u&&u.toLowerCase().endsWith('.mp3'))added.push({name:u.split('/').pop(),url:u});});
        playlist=playlist.concat(added);refreshSelect();loadTrack(0);audio.play();};
      r.readAsText(f);
    }
  });
  if(added.length&&!files.some(f=>f.name.endsWith('.txt'))){playlist=playlist.concat(added);refreshSelect();loadTrack(0);audio.play();}
};

/* (10) save / load config */
$('saveConfigFile').onclick=()=>{
  const cfg={visualizer:$('visualizationSelect').value,
    main:[...document.querySelectorAll('#visualizerColors input[type=color]')].map(n=>n.value),
    border:[...document.querySelectorAll('#borderColors input[type=color]')].map(n=>n.value),
    eq:[...document.querySelectorAll('#eqSliders input[type=range]')].map(n=>n.value)};
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(cfg,null,2)],{type:'text/plain'}));a.download='config.txt';a.click();
};
$('loadConfigFile').onclick=()=>$('configFileInput').click();
$('configFileInput').onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{
    try{const c=JSON.parse(ev.target.result);
      $('visualizationSelect').value=currentViz=c.visualizer;
      $('visualizerColors').innerHTML='';c.main.forEach(v=>$('visualizerColors').appendChild(makeColor(v)));
      $('borderColors').innerHTML='';c.border.forEach(v=>$('borderColors').appendChild(makeColor(v)));
      c.eq?.forEach((g,i)=>{filters[i]?.gain.setValueAtTime(g,audioCtx?.currentTime||0);document.querySelectorAll('#eqSliders input[type=range]')[i].value=g;});
      updateIconColors();
    }catch{alert('Invalid config');}};
  r.readAsText(f);
};

/* boot */
loadTrack(0);updateIconColors();
</script>
</body>
</html>
